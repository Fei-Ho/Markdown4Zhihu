# 1. PSNR (Peak Signal-to-Noise Ratio)峰值信噪比

给定一个大小为mxn的原始图像$I$和噪声图像$K$，均方误差$MSE$定义为：
$$
MSE=\frac{1}{mn}\sum_{i=0}^{m-1}\sum_{j=0}^{n-1}[I(i,j)-K(i,j)]^{2}
$$
$PSNR(db)$被定义为:
$$
PSNR = 10\cdot log_{10}\frac{(MAX_{I})^{2}}{MSE}
=20\cdot log_{10} \frac{MAX_{I}}{\sqrt{MSE}}
$$
其中，$MAX_{I}$为图片$I$中可能的最大像素值。通常，如果像素值由$B$位二进制来表示，那么$MAX_{I}=2^{B}-1$。一般地，针对 uint8 数据，最大像素值为 255；针对浮点型数据，最大像素值为 1。PSNR的值越大越好。

上面是针对灰度图像的计算方法，如果是彩色图像，通常有3种方法来计算：

1. 分别计算 RGB 三个通道的 PSNR，然后取平均值
2. <u>计算 RGB 三通道的 MSE ，然后再除以 3</u>
3. <u>将图片转化为 YCbCr 格式，然后只计算 Y 分量也就是亮度分量的 PSNR</u>

其中，第二和第三种方法比较常见。

# 2. SSIM (Mean Structural Similarity Index Measure)平均结构相似性

SSIM是一个广泛使用的图像质量评价指标，它是基于人眼会提取图像中结构化信息的假设，是一种衡量两幅图像相似度的指标。
SSIM基于样本$x$和$y$之间的三个比较衡量：亮度 (luminance)、对比度 (contrast) 和结构 (structure)。
$$
SSIM(x,y)=[l(x,y)^{\alpha}\cdot c(x,y)^{\beta}\cdot s(x,y)^{\gamma}]
$$
其中，$l(x, y)$是**亮度比较**，$c(x,y)$是**对比度比较**(图像明暗变化的剧烈程度，即像素的标准差)，$s(x,y)$是**结构比较**。$\alpha>0,\beta>0,\gamma>0$。$l(x, y)$、$c(x,y)$、$s(x,y)$的计算方式如下，
$$
l(x,y)=\frac{2\mu_{x}\mu_{y}+c_{1}}{\mu_{x}^{2}+\mu_{y}^{2}+c_{1}} \\
\mu_{x}=\frac{1}{H\times W} \sum_{i=1}^{H}\sum_{j=1}^{W}x(i,j) \\
\mu_{y}=\frac{1}{H\times W} \sum_{i=1}^{H}\sum_{j=1}^{W}y(i,j)
$$
其中，$\mu_{x}为$$x$的均值，$\mu_{y}$为$y$的均值，$c_{1}$是为了防止分母为0，$c_{1}=(k_{1}L)^{2}$，$k_{1}$是一个常数，且$k_{1}<<1$，默认取值为0.01，$L$为像素值的范围$2^{B}-1$。
$$
c(x,y)=\frac{2\sigma_{x}\sigma_{y}+c_{2}}{\sigma_{x}^{2}+\sigma_{y}^{2}+c_{2}}s(x,y) \\
\sigma_{x}=[\frac{1}{H\times W-1}\sum_{i=1}^{H}\sum_{j=1}^{W}(x(i,j)-\mu_{x})]^{1/2} \\
\sigma_{y}=[\frac{1}{H\times W-1}\sum_{i=1}^{H}\sum_{j=1}^{W}(x(i,j)-\mu_{y})]^{1/2}
$$
其中，$\sigma_{x}^{2}$为$x$的方差，$\sigma_{y}^{2}$为$y$的方差，$c_{2}$是防止分母为0，$c_{2}=(k_{2}L)^{2}$，$k_{2}$是一个常数，默认取值为0.03，$L$为像素值的范围$2^{B}-1$。
$$
s(x,y)=\frac{\sigma_{xy}+c_{3}}{\sigma_{x}\sigma_{y}+c_{3}}
$$
其中，$\sigma_{xy}$为$x$和$y$的协方差。一般取$c_{3}=\frac{c_{2}}{2}$。

当$\alpha=\beta=\gamma=1$时，可得，
$$
SSIM(x,y)=\frac{(2\mu_{x}\mu_{y}+c_{1})(2\sigma_{xy}+c_{2})}{(\mu_{x}^{2}+\mu_{y}^{2}+c_{1})(\sigma_{x}^{2}+\sigma_{y}^{2}+c_{2})} \\
sigma_{xy}=\frac{1}{H\times W}\sum_{i=1}^{H}\sum_{j=1}^{W}(x(i,j)-\mu_{x})(y(i,j)-\mu_{y})
$$
然而，上面的 SSIM 不能用于一整幅图。因为在整幅图的跨度上，均值和方差往往变化剧烈；同时图像上不同区块的失真程度也有可能不同，不能一概而论；此外类比人眼睛每次只能聚焦于一处的特点，作者采用 sliding window 以步长为 1 计算两幅图各个对应 sliding window 下的 patch 的 SSIM，然后取平均值作为两幅图整体的 SSIM，称为 **Mean SSIM**，简写为 **M-SSIM**。代码中，计算每个 patch 的均值和方差时，作者采用了方差为 1.5 的高斯卷积核作加权平均，滑窗大小为 11*11 ，如果像素$x_{i}$对应的高斯核权重为$w_i$。那么加权均值、方差、协方差的公式为：
$$
\mu_x=\sum_{i=1}^{N}w_{i}x_{i} \\
\sigma_{x}=(\sum_{i=1}^{N}w_{i}(x_{i}-\mu_{x})^{2})^{1/2} \\
\sigma_{xy}=\sum_{i=1}^{N} w_{i}(x_{i}-\mu_x)(y_{i]-\mu_{y}})
$$
如果整幅图有 M 个 patch，那么 MSSIM 公式为：
$$
M-SSIM(x,y)=\frac{1}{M}\sum_{j=1}^{M}SSIM(x_{patch_{j}},y_{patch_{j}})
$$

# 3. MS-SSIM (Multi Scale Structural Similarity Index Measure) 多尺度结构相似性

图像细节的可感知性取决于<u>图像信号的采样密度</u>、<u>图像平面到观察者的距离</u>以及<u>观察者视觉系统的感知能力</u>。在实践中，当这些因素发生变化时，对给定图像的主观评价就会发生变化。MS-SSIM的评估结果可以更贴近主观质量评估结果。

多尺度方法考察不同分辨率情况下的图像细节。其系统图如下图所示，

<img src="D:\Typora\TyporaContent\image\MS-SSIM系统图.png" style="zoom:33%;" />

将参考和失真图像信号作为输入，迭代应用低通滤波器，将滤波后的图像降采样2倍。原始图像的分辨率记为$Scale_{1}$，经过$M-1$次迭代后图像的分辨率记为$Scale_{M}$。在每个迭代得到的尺度上计算SSIM中的对比度衡量$c_{j}(x,y)$和结构衡量$s_{j}(x,y)$，仅在最后一个尺度$Scale_{M}$上计算亮度衡量$l_{M}(x,y)$。

通过综合不同尺度上衡量的结果，得到综合指标$MS-SSIM$,
$$
MS-SSIM(x,y)=[l(x,y)]^{\alpha_M}\cdot \prod_{j=1}^{M}[c(x,y)]^{\beta_{j}}\cdot[s(x,y)]^{\gamma_{j}}
$$
采用指数$\alpha_{M}$、$\beta_{j}$、$\gamma_{j}$来调整不同分量的相对重要性。为了简化参数的选择，让所有$\alpha_{j}=\beta_{j}=\gamma_{j}$。对交叉尺度设置进行标准化，
$$
\sum_{j=1}^{M}\gamma_{j}=1
$$
使得不同的参数设置(包括所有但尺度和多尺度设置)具有可比性。

经过实验得到各尺度下的参数值为:
$$
\beta_{1}=\gamma_{1}=0.0448 \\
\beta_{2}=\gamma_{2}=0.2856 \\
\beta_{3}=\gamma_{3}=0.3001 \\
\beta_{4}=\gamma_{4}=0.2363 \\
\alpha_{5}=\beta_{5}=\gamma_{5}=0.1333
$$



